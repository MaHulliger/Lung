---
title: "Correlation_approach"
author: "Matthias Hulliger"
date: "6/13/2020"
output: html_document
---
```{r,fig.width=10,fig.height=6,message=FALSE}
library(DESeq)
library(miRComb)
```

#Load miRNA and mRNA count table
```{r,fig.width=10,fig.height=6}
mRNA<-read.table("/Users/matthias/R_DE_mirna_analysis/lung/mrna/10112017_gene_based_analysis/mRNA_norm_counts.txt",header=T)
miRNA<-read.table("/Users/matthias/R_DE_mirna_analysis/lung/mrna/10112017_gene_based_analysis/miRNA_norm_counts.txt",header=T)
str(miRNA)
str(mRNA)
colnames(mRNA)<-colnames(miRNA)
colnames(mRNA)
colnames(miRNA)
head(miRNA)
head(mRNA)
#log transform the normalized data + pseudocount of 1
miRNA<-log2(miRNA+1)
mRNA<-log2(mRNA+1)
head(mRNA)
head(miRNA)
write.table(rownames(miRNA),"/Users/matthias/Downloads/blast_homologous_mirnas/mirna_names.txt",quote = F)
```

#Select significant DE mRNAs
```{r,fig.width=10,fig.height=6}
DEmRNA<-read.table("/Users/matthias/R_DE_mirna_analysis/lung/mrna/10112017_gene_based_analysis/DEG_SvC_ECab3.txt",header=T)
head(DEmRNA)
dim(DEmRNA)
#load BIomart conversion table with unique! names CXCL5 has to be added manually for ease of handling
conversion_table<-read.table("/Users/matthias/Downloads/modified_coversion_unique.txt",header=T)
head(conversion_table)
dim(conversion_table)
conversion_table<-as.data.frame(conversion_table)
conversion_table


#Select relevant rows from expression matrix:
mRNA_SvC<-mRNA[rownames(mRNA) %in% conversion_table[,2],]
#Convert from human to horse IDs
test<-conversion_table$Human_gene_name[match(rownames(mRNA_SvC),conversion_table[,2])]
rownames(mRNA_SvC)<-test
test
#add the two duplicates AC068234.1           ITGB3
itgb3<-mRNA_SvC["ITGB3",]
rownames(itgb3)<-"AC068234.1"
cxcl6<-mRNA_SvC["CXCL5",]
rownames(cxcl6)<-"CXCL6"
cxcl6

mRNA_final<-rbind(mRNA_SvC,cxcl6)
mRNA_final<-rbind(mRNA_final,itgb3)

rownames(mRNA_final)
#Qualitycontrol of the mutation
#tail(mRNA_test)
#mRNA_test["CXCL5",]
#mRNA_test["CXCL6",]
mRNA_final["IL13RA2",]
mRNA["IL13RA2",]
dim(mRNA)
dim(mRNA_final)
head(mRNA_final)
```

#Prepare SvC significant miRNAs
```{r,fig.width=6,fig.height=6}
DEmirs<-c("hsa-mir-142-5p","hsa-mir-142-3p","hsa-mir-212-3p","hsa-mir-223-3p","hsa-mir-224-5p","hsa-mir-26a-5p","hsa-mir-31-5p")
DEmirs_horse<-c("eca-miR-142-3p","eca-miR-142-5p","eca-miR-223","eca-miR-212","eca-miR-224","eca-miR-31","eca-miR-26a")
miRNA_SvC<-miRNA[rownames(miRNA) %in% DEmirs_horse,]
miRNA_SvC
rownames(miRNA_SvC)<-DEmirs
dim(miRNA_SvC)
miRNA_SvC
DEmirs<-c("hsa-miR-142-5p","hsa-miR-142-3p","hsa-miR-212-3p","hsa-miR-223-3p","hsa-miR-224-5p","hsa-miR-26a-5p","hsa-miR-31-5p")
length(DEmirs)
rownames(miRNA_SvC)<-DEmirs

#Create phentype table.
x<-rep(1,times=19)
y<-rep(1,times=19)
pheno<-cbind(x,y)
colnames(pheno)<-c("group","SvC")
pheno<-as.data.frame(pheno)
pheno$group[1:8]<-"C"
pheno$group[9:13]<-"A"
pheno$group[14:19]<-"S"
rownames(pheno)<-colnames(miRNA_SvC)
pheno
pheno_SvC<-rbind(pheno[1:8,],pheno[14:19,])
pheno_SvC$SvC[1:8]<-0
pheno_SvC
#remove asymptomatic columns from count matrices
miRNA_SvC<-miRNA_SvC[,colnames(miRNA_SvC) %in% rownames(pheno_SvC)]
mRNA_final<-mRNA_final[,colnames(mRNA_final) %in% rownames(pheno_SvC)]
head(mRNA_final)
#start mirComb analysis
data.obj<-new("corObject",dat.miRNA=as.matrix(miRNA_SvC),dat.mRNA=as.matrix(mRNA_final),pheno.miRNA=pheno_SvC,pheno.mRNA=pheno_SvC)
str(data.obj)
#Add 'significant' miRNA and mRNAs so basically just the rownames.
data.obj<-addSig(data.obj,"miRNA",manual=rownames(miRNA_SvC))
data.obj<-addSig(data.obj,"mRNA",manual=rownames(mRNA_final))
str(data.obj)
data.obj<-addCorrelation(data.obj,alternative="less")
data.obj@pval[1:7,1:10]
plotCorrelation(data.obj,miRNA="hsa-miR-26a-5p",mRNA="AMPD2",type="residuals")
plotCorrelation(data.obj,miRNA="hsa-miR-26a-5p",mRNA="AMPD2",type="cor",col.color="group",sample.names=TRUE)
boxplotCorrelation(data.obj, "hsa-miR-26a-5p", "AMPD2", pos.leg="topleft")


miRNA_SvC["hsa-miR-26a-5p",]
mRNA_final["AMPD2",]
cor.test(as.numeric(miRNA_SvC["hsa-miR-26a-5p",]),as.numeric(mRNA_final["AMPD2",]),method="pearson",alternative="less")

str(data.obj)
#Adjust p-values
pvals<-data.obj@pval

data.obj@pval[1:7,1:7]

#check out some highly significant one pairs:
boxplotCorrelation(data.obj, "hsa-miR-212-3p", "CCDC68", pos.leg="topleft")
plotCorrelation(data.obj,miRNA="hsa-miR-212-3p",mRNA="CCDC68",type="cor",col.color="group",sample.names=TRUE)
plotCorrelation(data.obj,miRNA="hsa-miR-26a-5p",mRNA="CXCL6",type="cor",col.color="group",sample.names=TRUE)
boxplotCorrelation(data.obj, "hsa-miR-26a-5p", "CXCL6", pos.leg="topright")
data.obj<-addNet(data.obj)
head(data.obj@net)
data(microCosm_v5_18)
data(targetScan_v7.0_21)
data(PITA_v6_11_TOP)
data(miRDB_v5.0_21)
data(miRSVR_aug10_17)
data.obj<-addDatabase(data.obj,database=c("microCosm_v5_18","targetScan_v7.0_21","miRDB_v5.0_21","miRSVR_aug10_17"))
#data.obj@net
data.obj<-correctPval(data.obj, pval="pval",method.adj="BH")
idx<-data.obj@net$dat.sum>0
data.obj@net[idx,]
#this is used to check the significant interaction before intersection with database
idx<-(data.obj@net$adj.pval<0.05 & data.obj@net$dat.sum>0)
data.obj@net[idx,]
results<-data.obj@net[idx,]
topTable(data.obj,"miRNA",names=TRUE,pval.cutoff=0.05,plot=TRUE)
results<-as.data.frame(results)
write.table(results,"SvC_correlations_table.txt",quote=F)
for(i in 1:nrow(results)) {
    row <- results[i,]
    #print(row)
    #print(row[1])
    #print(row$miRNA)
    #print(as.character(row[1]))
    #str(row[1])
    #str(row[2])
    boxplotCorrelation(data.obj, row$miRNA, row$mRNA, pos.leg="topright")
     plotCorrelation(data.obj,miRNA=row$miRNA,mRNA=row$mRNA,type="cor",col.color="group",sample.names=F)
    plotCorrelation(data.obj,miRNA=row$miRNA,mRNA=row$mRNA,type="residuals")
    # do stuff with row
}


```

```{r,fig.width=6,fig.height=8}
dim(mRNA_final)
dim(miRNA_SvC)
head(mRNA_final)
head(miRNA_SvC)

#compare correlation coefficients spearman vs  pearson:
x<-as.matrix(miRNA_SvC)
y<-as.matrix(mRNA_final)
head(y)
for (i in 1:7){
   pears<-numeric(10)
   spearm<-numeric(10)
  for (j in 1:183){
    #loop over all rows of y. E.g correlation of miRNA1 with all mRNAs
    test_p<-cor.test(x[i,],y[j,],method = "pearson")
    test_s<-cor.test(x[i,],y[j,],method = "spearman")
    pears[j]<-test_p$estimate
    spearm[j]<-test_s$estimate
  if(j == 183){print(test_p$estimate)
  print(test_s$estimate)}
  
  }
   if (i==1){
     mat_p<-pears
     mat_s<-spearm
   }else{
     mat_p<-rbind(mat_p,pears)
     mat_s<-rbind(mat_s,spearm)
   }
  
   #print(pears)
   #print(spearm)
  
}
print(mat_s)
print(mat_p)

##Check the difference between spearman and pearson
diff<-abs(mat_p-mat_s)
head(diff)
mean(diff)
median(diff)
boxplot(as.vector(diff))

##impelent a method to count how many times the spearman coefficiant was bigger/smaller than the pearson coefficient:
Sbigger<-0
Ssmaller<-0
for (i in 1:7){
  for (j in 1:183){
  if (mat_s[i,j] > mat_p[i,j]){
    Sbigger <- Sbigger+ 1
  }else{Ssmaller <- Ssmaller +1}
    
  }
}
print(Ssmaller+Sbigger)
print(Ssmaller)
print(Sbigger)
```

#Now the anaysis for the contrast of Asymptomatic horses in remission vs. healthy controls:

#Load miRNA and mRNA count table
```{r,fig.width=5,fig.height=6}
mRNA<-read.table("/Users/matthias/R_DE_mirna_analysis/lung/mrna/10112017_gene_based_analysis/mRNA_norm_counts.txt",header=T)
miRNA<-read.table("/Users/matthias/Downloads/miRComb/normalized_miRNA_counts_for_mircomb.txt",header=T)
str(miRNA)
str(mRNA)
colnames(mRNA)<-colnames(miRNA)
colnames(mRNA)
colnames(miRNA)
head(miRNA)
head(mRNA)
#log transform the normalized data + pseudocount of 1
miRNA<-log2(miRNA+1)
mRNA<-log2(mRNA+1)
head(mRNA)
head(miRNA)
```

#Select significant DE mRNAs
```{r,fig.width=6,fig.height=6}
DEmRNA<-read.table("/Users/matthias/Downloads/miRComb/genelist_SvA.txt",header=T)
head(DEmRNA)
dim(DEmRNA)
#load BIomart conversion table with unique! names CXCL5 has to be added manually for ease of handling
conversion_table<-read.table("/Users/matthias/Downloads/miRComb/conversion_table_S_A.txt",header=T)
head(conversion_table)
dim(conversion_table)
conversion_table<-as.data.frame(conversion_table)
conversion_table
#Select relevant rows from expression matrix:
mRNA_SvC<-mRNA[rownames(mRNA) %in% conversion_table[,2],]
#Convert from human to horse IDs
test<-conversion_table$Human_gene_name[match(rownames(mRNA_SvC),conversion_table[,2])]
test
rownames(mRNA_SvC)<-test
mRNA_final<-mRNA_SvC
#Prepare SvC significant miRNAs
 
DEmirs<-c("hsa-miR-146b-5p","hsa-miR-135b-5p","hsa-miR-31-5p")
DEmirs_horse<-c("eca-miR-146b-5p","eca-miR-135b","eca-miR-31")
miRNA_SvC<-miRNA[rownames(miRNA) %in% DEmirs_horse,]
miRNA_SvC
rownames(miRNA_SvC)<-DEmirs
dim(miRNA_SvC)
miRNA_SvC
rownames(miRNA_SvC)<-DEmirs

#Create phentype table.
x<-rep(1,times=19)
y<-rep(1,times=19)
pheno<-cbind(x,y)
colnames(pheno)<-c("group","SvC")
pheno<-as.data.frame(pheno)
pheno$group[1:8]<-"C"
pheno$group[9:13]<-"A"
pheno$group[14:19]<-"S"
rownames(pheno)<-colnames(miRNA_SvC)
pheno
pheno_SvC<-rbind(pheno[9:13,],pheno[14:19,])
pheno_SvC$SvC[1:5]<-0
pheno_SvC
#remove asymptomatic columns from count matrices
miRNA_SvC<-miRNA_SvC[,colnames(miRNA_SvC) %in% rownames(pheno_SvC)]
mRNA_final<-mRNA_final[,colnames(mRNA_final) %in% rownames(pheno_SvC)]
dim(mRNA_final)
dim(miRNA_SvC)
head(mRNA_final)
head(miRNA_SvC)
#start mirComb analysis
data.obj<-new("corObject",dat.miRNA=as.matrix(miRNA_SvC),dat.mRNA=as.matrix(mRNA_final),pheno.miRNA=pheno_SvC,pheno.mRNA=pheno_SvC)
str(data.obj)
data.obj<-addSig(data.obj,"miRNA",manual=rownames(miRNA_SvC))
data.obj<-addSig(data.obj,"mRNA",manual=rownames(mRNA_final))
str(data.obj)
data.obj<-addCorrelation(data.obj,alternative="less")

#data.obj@pval[1:7,1:10]
data.obj<-addNet(data.obj)
head(data.obj@net)
data(microCosm_v5_18)
data(targetScan_v7.0_21)
data(PITA_v6_11_TOP)
data(miRDB_v5.0_21)
data(miRSVR_aug10_17)
data(targetScan_v6.2_18)
data.obj<-addDatabase(data.obj,database=c("microCosm_v5_18","targetScan_v7.0_21","miRDB_v5.0_21","miRSVR_aug10_17","targetScan_v6.2_18"))
data.obj@net
data.obj<-correctPval(data.obj, pval="pval",method.adj="BH")
data.obj
idx<-(data.obj@net$adj.pval<0.05 & data.obj@net$dat.sum>0)
data.obj@net[idx,]
results<-data.obj@net[idx,]
topTable(data.obj,"miRNA",names=TRUE,pval.cutoff=0.05,plot=TRUE)
results<-as.data.frame(results)
write.table(results,"AvC_correlations_table.txt",quote=F)
